# Using AWS Lambda to automate the process and reduce cost
![Alt text](/images/lambda-trigger.png)

In order to automate and save costs, it would be perfect that, just when the new batch of reddit messages hit the S3, we process them. That is the point of this step!
The best about that is that we can have the EC2 instance stoppped and only run when triggered by Lambda!

## Create Lambda function
1. Go to [Lambda function](https://aws.amazon.com/pm/lambda/?trk=96858a58-f2ac-44e1-8d07-8ec9590efd51&sc_channel=ps&ef_id=Cj0KCQjwpc-oBhCGARIsAH6ote_asxJqlxJAYO5bouxcpjegWHeNGMMTwb272CEMuxUHrvdFGjO-2RMaAqTBEALw_wcB:G:s&s_kwcid=AL!4422!3!651510153330!e!!g!!aws%20lambda!19828209774!147081382077) --> Create function
2. Select:
   Author from scratch
   Function name: s3-trigger-EC2
   Rutime: Python 3.11
3. Create function
4. Add the [lambda function](/AWS/lambda/lambda.py) code:

```python
import json
import boto3

print("Loading function")

s3 = boto3.client("s3")
ec2 = boto3.client("ec2", region_name = "eu-west-3")
instance_id = "i-123456789" # replace with your instance ID

def lambda_handler(event, context):
    # Event generated by a change in the S3
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = event['Records'][0]['s3']['object']['key']
    
    # Check if the event corresponds to a new raw json messages from Reddit:
    if key == "reddit-posts.json":
        try:
            ec2.start_instances(InstanceIds=[instance_id])
            print(f'Started EC2 instance {instance_id}')
            
            return {
                'statusCode': 200,
                'body': 'EC2 instance started successfully.'
            }
        except Exception as e:
            print(f'Error starting EC2 instance {instance_id}: {str(e)}')
            raise e
    
    return {
        'statusCode': 200,
        'body': json.dumps('Hello from Lambda!')
    }

```
Rmember to replace the code with your instance id!

5. Test and deploy your function.

## Create event notification in S3
1. Go to your S3 bucket
2. Properties --> Create event notification
3. There are multiple ways to configure, for this scenario, I chose to add Suffix, in order to reduce the number of checks of the Lambda function. Besides, select "All object create events":


![Alt text](/images/s3-event.png)


4. Add the lambda function recently deployed as destination:
   
![Alt text](/images/destination-lambda.png)


5. Save changes

We are good to go! Whenever the S3 bucket gets new reddit posts, it will trigger the lambda function, that will start the EC2 instance!
